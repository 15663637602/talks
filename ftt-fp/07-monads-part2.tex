\batchmode
\makeatletter
\def\input@path{{/Users/sergei.winitzki/Code/talks/ftt-fp/}}
\makeatother
\documentclass[english]{beamer}
\usepackage[T1]{fontenc}
\usepackage[latin9]{inputenc}
\setcounter{secnumdepth}{3}
\setcounter{tocdepth}{3}
\usepackage{babel}
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage[all]{xy}
\ifx\hypersetup\undefined
  \AtBeginDocument{%
    \hypersetup{unicode=true,pdfusetitle,
 bookmarks=true,bookmarksnumbered=false,bookmarksopen=false,
 breaklinks=false,pdfborder={0 0 1},backref=false,colorlinks=true}
  }
\else
  \hypersetup{unicode=true,pdfusetitle,
 bookmarks=true,bookmarksnumbered=false,bookmarksopen=false,
 breaklinks=false,pdfborder={0 0 1},backref=false,colorlinks=true}
\fi

\makeatletter
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% Textclass specific LaTeX commands.
 % this default might be overridden by plain title style
 \newcommand\makebeamertitle{\frame{\maketitle}}%
 % (ERT) argument for the TOC
 \AtBeginDocument{%
   \let\origtableofcontents=\tableofcontents
   \def\tableofcontents{\@ifnextchar[{\origtableofcontents}{\gobbletableofcontents}}
   \def\gobbletableofcontents#1{\origtableofcontents}
 }
 \newenvironment{lyxcode}
   {\par\begin{list}{}{
     \setlength{\rightmargin}{\leftmargin}
     \setlength{\listparindent}{0pt}% needed for AMS classes
     \raggedright
     \setlength{\itemsep}{0pt}
     \setlength{\parsep}{0pt}
     \normalfont\ttfamily}%
    \def\{{\char`\{}
    \def\}{\char`\}}
    \def\textasciitilde{\char`\~}
    \item[]}
   {\end{list}}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% User specified LaTeX commands.
\usetheme[secheader]{Boadilla}
\usecolortheme{seahorse}
\title[Chapter 7: Functor-lifted computations II]{Chapter 7: Computations lifted to a functor context II. Monads}
\subtitle{Part 2: Laws and structure of semimonads}
\author{Sergei Winitzki}
\date{2018-03-11}
\institute[ABTB]{Academy by the Bay}
\setbeamertemplate{headline}{} % disable headline at top
\setbeamertemplate{navigation symbols}{} % disable navigation bar at bottom
\usepackage[all]{xy}
\makeatletter
% Macros to assist LyX with XYpic when using scaling.
\newcommand{\xyScaleX}[1]{%
\makeatletter
\xydef@\xymatrixcolsep@{#1}
\makeatother
} % end of \xyScaleX
\makeatletter
\newcommand{\xyScaleY}[1]{%
\makeatletter
\xydef@\xymatrixrowsep@{#1}
\makeatother
} % end of \xyScaleY

\makeatother

\begin{document}
\frame{\titlepage}
\begin{frame}{Semimonad laws I: The intuitions}

What properties of functor block programs do we expect to have?
\begin{itemize}
\item In \texttt{\textcolor{blue}{\footnotesize{}x $\leftarrow$ c}}, the
value of \texttt{\textcolor{blue}{\footnotesize{}x}} will \emph{go
over items} held in container \texttt{\textcolor{blue}{\footnotesize{}c}} 
\item Manipulating items in container is followed by a generator:
\end{itemize}
\texttt{\textcolor{blue}{\footnotesize{}}}%
\begin{minipage}[c][1\totalheight][t]{0.49\columnwidth}%
\begin{lyxcode}
\textcolor{blue}{\footnotesize{}x~$\leftarrow$~cont1}{\footnotesize \par}

\textcolor{blue}{\footnotesize{}y~=~f(x)}{\footnotesize \par}

\textcolor{blue}{\footnotesize{}z~$\leftarrow$~cont2(y)}{\footnotesize \par}
\end{lyxcode}
%
\end{minipage}\texttt{\textcolor{blue}{\footnotesize{}\hfill{}}}%
\begin{minipage}[c][1\totalheight][t]{0.4\columnwidth}%
\begin{lyxcode}
\textcolor{blue}{\footnotesize{}y~$\leftarrow$~cont1}{\footnotesize \par}

\textcolor{blue}{\footnotesize{}~~~~~~.map(x~$\Rightarrow$~f(x))}{\footnotesize \par}

\textcolor{blue}{\footnotesize{}z~$\leftarrow$~cont2(y)}{\footnotesize \par}
\end{lyxcode}
%
\end{minipage}\texttt{\textcolor{blue}{\footnotesize{}\hfill{}\medskip{}
}}{\footnotesize \par}

\texttt{\textcolor{blue}{\footnotesize{}cont1.flatMap(x $\Rightarrow$
cont2(f(x))) = cont1.map(f).flatMap(y $\Rightarrow$ cont2(y))}} 
\begin{itemize}
\item Manipulating items in container is preceded by a generator:
\end{itemize}
\texttt{\textcolor{blue}{\footnotesize{}}}%
\begin{minipage}[c][1\totalheight][t]{0.49\columnwidth}%
\begin{lyxcode}
\textcolor{blue}{\footnotesize{}x~$\leftarrow$~cont1}{\footnotesize \par}

\textcolor{blue}{\footnotesize{}y~$\leftarrow$~cont2(x)}{\footnotesize \par}

\textcolor{blue}{\footnotesize{}z~=~f(y)}{\footnotesize \par}
\end{lyxcode}
%
\end{minipage}\texttt{\textcolor{blue}{\footnotesize{}\hfill{}}}%
\begin{minipage}[c][1\totalheight][t]{0.49\columnwidth}%
\begin{lyxcode}
\textcolor{blue}{\footnotesize{}x~$\leftarrow$~cont1}{\footnotesize \par}

\textcolor{blue}{\footnotesize{}z~$\leftarrow$~cont2(x)}{\footnotesize \par}

\textcolor{blue}{\footnotesize{}~~~~~~~.map(f)}{\footnotesize \par}
\end{lyxcode}
%
\end{minipage}\texttt{\textcolor{blue}{\footnotesize{}\hfill{}\medskip{}
cont1.flatMap(cont2).map(f)}} \texttt{\textcolor{blue}{\footnotesize{}=
cont1.flatMap(x $\Rightarrow$ cont2(x).map(f))}} 
\begin{itemize}
\item After \texttt{\textcolor{blue}{\footnotesize{}x $\leftarrow$ cont}},
further computations will use \emph{all those} \texttt{\textcolor{blue}{\footnotesize{}x}} 
\end{itemize}
\texttt{\textcolor{blue}{\footnotesize{}}}%
\begin{minipage}[c][1\totalheight][t]{0.49\columnwidth}%
\begin{lyxcode}
\textcolor{blue}{\footnotesize{}x~$\leftarrow$~cont}{\footnotesize \par}

\textcolor{blue}{\footnotesize{}y~$\leftarrow$~p(x)}{\footnotesize \par}

\textcolor{blue}{\footnotesize{}z~$\leftarrow$~cont2(y)}{\footnotesize \par}
\end{lyxcode}
%
\end{minipage}\texttt{\textcolor{blue}{\footnotesize{}\hfill{}}}%
\begin{minipage}[c][1\totalheight][t]{0.49\columnwidth}%
\begin{lyxcode}
\textcolor{blue}{\footnotesize{}y~$\leftarrow$~for~\{~x~$\leftarrow$~cont}{\footnotesize \par}

\textcolor{blue}{\footnotesize{}~~~~~~~~~~~yy~$\leftarrow$~p(x)~\}~yield~yy}{\footnotesize \par}

\textcolor{blue}{\footnotesize{}z~$\leftarrow$~cont2(y)}{\footnotesize \par}
\end{lyxcode}
%
\end{minipage}\texttt{\textcolor{blue}{\footnotesize{}\hfill{}\medskip{}
cont.flatMap(x $\Rightarrow$ p(x).flatMap(cont2)) = cont.flatMap(p).flatMap(cont2)}} 
\end{frame}

\begin{frame}{Semimonad laws II: The laws for \texttt{\textcolor{blue}{\footnotesize{}flatMap}} }

To get a more concise notation, use {\footnotesize{}$\text{flm}$}
instead of \texttt{\textcolor{blue}{\footnotesize{}flatMap}} 

A \textbf{semimonad} $S^{A}$ has {\footnotesize{}$\text{flm}^{\left[S,A,B\right]}:\left(A\Rightarrow S^{B}\right)\Rightarrow S^{A}\Rightarrow S^{B}$}
with 3 laws:
\begin{enumerate}
\item {\footnotesize{}$\text{flm}\,(f^{A\Rightarrow B}\circ g^{B\Rightarrow S^{C}})=\text{fmap}\,f\circ\text{flm}\,g$}
{\footnotesize{}(naturality in $A$)} {\footnotesize{}
\[
\xymatrix{\xyScaleY{0.2pc}\xyScaleX{3pc} & S^{B}\ar[rd]\sp(0.5){\ \text{flm}\,g^{B\Rightarrow S^{C}}}\\
S^{A}\ar[ru]\sp(0.5){\text{fmap}\,f^{A\Rightarrow B}\ }\ar[rr]\sb(0.5){\text{flm}\,(f^{A\Rightarrow B}\circ\,g^{B\Rightarrow S^{C}})\,} &  & S^{C}
}
\]
}{\footnotesize \par}
\item {\footnotesize{}$\text{flm}\,\big(f^{A\Rightarrow S^{B}}\circ\text{fmap}\,g^{B\Rightarrow C}\big)=\text{flm}\,f\circ\text{fmap}\,g$}
{\footnotesize{}(naturality in $B$)} {\footnotesize{}
\[
\xymatrix{\xyScaleY{0.2pc}\xyScaleX{3pc} & S^{B}\ar[rd]\sp(0.5){\ \text{fmap}\,g^{B\Rightarrow C}}\\
S^{A}\ar[ru]\sp(0.5){\text{flm}\,f^{A\Rightarrow S^{B}}\ }\ar[rr]\sb(0.5){\text{flm}\,(f^{A\Rightarrow S^{B}}\circ\,\text{fmap}\,g^{B\Rightarrow C})\,} &  & S^{C}
}
\]
}{\footnotesize \par}
\item {\footnotesize{}$\text{flm}\,\big(f^{A\Rightarrow S^{B}}\circ\text{flm}\,g^{B\Rightarrow S^{C}}\big)=\text{flm}\,f\circ\text{flm}\,g$}
{\footnotesize{}(associativity)} {\footnotesize{}
\[
\xymatrix{\xyScaleY{0.2pc}\xyScaleX{3pc} & S^{B}\ar[rd]\sp(0.5){\ \text{flm}\,g^{B\Rightarrow S^{C}}}\\
S^{A}\ar[ru]\sp(0.5){\text{flm}\,f^{A\Rightarrow S^{B}}\ }\ar[rr]\sb(0.5){\text{flm}\,\big(f^{A\Rightarrow S^{B}}\circ\,\text{flm}\,g^{B\Rightarrow S^{C}}\big)\,} &  & S^{C}
}
\]
}{\footnotesize \par}
\end{enumerate}
Is there a shorter formulation of the laws?
\end{frame}

\begin{frame}{Semimonad laws III: The laws for \texttt{\textcolor{blue}{\footnotesize{}flatten}} }

The methods \texttt{\textcolor{blue}{\footnotesize{}flatten}} (denoted
by {\footnotesize{}$\text{ftn}$}) and \texttt{\textcolor{blue}{\footnotesize{}flatMap}}
are equivalent:\texttt{\textcolor{blue}{\footnotesize{} }}%
\begin{minipage}[c][1\totalheight][t]{0.4\columnwidth}%
{\footnotesize{}
\begin{align*}
\text{ftn}^{\left[S,A\right]}:S^{S^{A}}\Rightarrow S^{A} & =\text{flm}^{\left[S,S^{A},A\right]}(m^{S^{A}}\Rightarrow m)\\
\text{flm}\,\big(f^{A\Rightarrow S^{B}}\big) & =\text{fmap}\,f\circ\text{ftn}
\end{align*}
}%
\end{minipage}\texttt{\textcolor{blue}{\footnotesize{}\hfill{}}}%
\begin{minipage}[c][1\totalheight][t]{0.4\columnwidth}%
{\footnotesize{}
\[
\xymatrix{\xyScaleY{0.2pc}\xyScaleX{3pc} & S^{S^{B}}\ar[rd]\sp(0.5){\ \text{ftn}\ }\\
S^{A}\ar[ru]\sp(0.5){\text{fmap}\,f^{A\Rightarrow S^{B}}\ }\ar[rr]\sb(0.5){\text{flm}\,\big(f^{A\Rightarrow S^{B}}\big)\,} &  & S^{B}
}
\]
}%
\end{minipage}\texttt{\textcolor{blue}{\footnotesize{}\  \  \ \hfill{}}}{\footnotesize \par}

It turns out that \texttt{\textcolor{blue}{\footnotesize{}flatten}}
has only 2 laws:
\begin{enumerate}
\item {\footnotesize{}$\text{fmap}\big(\text{fmap}\,f^{A\Rightarrow B}\big)\circ\text{ftn}^{\left[S,B\right]}=\text{ftn}^{\left[S,A\right]}\circ\text{fmap}\,f$}
{\footnotesize{}(naturality)
\[
\xymatrix{\xyScaleY{0.2pc}\xyScaleX{5pc} & S^{S^{B}}\ar[rd]\sp(0.5){\ \text{ftn}^{\left[S,B\right]}}\\
S^{S^{A}}\ar[ru]\sp(0.5){\text{fmap}\,\big(\text{fmap}\,f^{A\Rightarrow B}\big)\ \ }\ar[rd]\sb(0.5){\text{ftn}^{\left[S,A\right]}\,} &  & S^{B}\\
 & S^{A}\ar[ru]\sb(0.5){\text{fmap}\,f^{A\Rightarrow B}}
}
\]
}{\footnotesize \par}
\item {\footnotesize{}$\text{fmap}\,(\text{ftn}^{\left[S,A\right]})\circ\text{ftn}^{\left[S,A\right]}=\text{ftn}^{[S,S^{A}]}\circ\text{ftn}^{\left[S,A\right]}$}
{\footnotesize{}(associativity) 
\[
\xymatrix{\xyScaleY{0.2pc}\xyScaleX{5pc} & S^{S^{A}}\ar[rd]\sp(0.5){\ \text{ftn}^{\left[S,A\right]}}\\
S^{S^{S^{A}}}\ar[ru]\sp(0.5){\text{fmap}\,(\text{ftn}^{\left[S,A\right]})\ }\ar[rd]\sb(0.5){\text{ftn}^{[S,S^{A}]}\,} &  & S^{A}\\
 & S^{S^{A}}\ar[ru]\sb(0.5){\text{ftn}^{\left[S,A\right]}}
}
\]
}{\footnotesize \par}
\end{enumerate}
\end{frame}

\begin{frame}{Equivalence of a natural transformation and a ``lifting''}
\begin{itemize}
\item Equivalence of {\footnotesize{}$\text{flm}$} and {\footnotesize{}$\text{ftn}$}:
{\footnotesize{}$\text{ftn}=\text{flm}\left(\text{id}\right)$; $\text{flm}\,f=\text{fmap}\,f\circ\text{ftn}$} 
\item We saw this before: {\footnotesize{}$\text{deflate}=\text{fmapOpt}\left(\text{id}\right)$};
{\footnotesize{}$\text{fmapOpt}\,f=\text{fmap}\:f\circ\text{deflate}$} 
\begin{itemize}
\item Is there a general pattern where two such functions are equivalent?
\end{itemize}
\item Let {\footnotesize{}$\text{tr}:F^{G^{A}}\Rightarrow F^{A}$ }be a
natural transformation ($F$ and $G$ are functors)
\item Define {\footnotesize{}$\text{ftr}:\left(A\Rightarrow G^{B}\right)\Rightarrow F^{A}\Rightarrow F^{B}$}
by {\footnotesize{}$\text{ftr}\,f=\text{fmap}\,f\circ\text{tr}$} 
\item It follows that {\footnotesize{}$\text{tr}=\text{ftr}\left(\text{id}\right)$},
and we have equivalence between {\footnotesize{}$\text{tr}$} and
{\footnotesize{}$\text{ftr}$}:\texttt{\textcolor{blue}{\footnotesize{} }}%
\begin{minipage}[c][1\totalheight][t]{0.4\columnwidth}%
{\footnotesize{}
\begin{align*}
\text{tr}:F^{G^{A}}\Rightarrow F^{A} & =\text{ftr}(m^{G^{A}}\Rightarrow m)\\
\text{ftr}\,\big(f^{A\Rightarrow G^{B}}\big) & =\text{fmap}\,f\circ\text{tr}
\end{align*}
}%
\end{minipage}\texttt{\textcolor{blue}{\footnotesize{}\hfill{}}}%
\begin{minipage}[c][1\totalheight][t]{0.4\columnwidth}%
{\footnotesize{}
\[
\xymatrix{\xyScaleY{0.2pc}\xyScaleX{3pc} & F^{G^{B}}\ar[rd]\sp(0.5){\ \text{tr}\ }\\
F^{A}\ar[ru]\sp(0.5){\text{fmap}\,f^{A\Rightarrow G^{B}}\ }\ar[rr]\sb(0.5){\text{ftr}\,\big(f^{A\Rightarrow G^{B}}\big)\,} &  & F^{B}
}
\]
}%
\end{minipage}\texttt{\textcolor{blue}{\footnotesize{}\  \  \ \hfill{}}}{\footnotesize \par}
\item An automatic law for {\footnotesize{}$\text{ftr}$} (``naturality
in $A$'') follows from the definition: {\footnotesize{}$\text{fmap}\,g\circ\text{ftr}\,f=\text{fmap}\,g\circ\text{fmap}\,f\circ\text{tr}=\text{fmap}\left(g\circ f\right)\circ\text{tr}=\text{ftr}\left(g\circ f\right)$} 
\begin{itemize}
\item This is why {\footnotesize{}$\text{tr}$} has \emph{one law fewer}
than {\footnotesize{}$\text{ftr}$}{\footnotesize \par}
\end{itemize}
\item To demonstrate equivalence in the direction {\footnotesize{}$\text{ftr}\rightarrow\text{tr}$}:
start with an arbitrary {\footnotesize{}$\text{ftr}$} satisfying
``naturality in $A$'', then obtain {\footnotesize{}$\text{tr}=\text{ftr}\left(\text{id}\right)$}
from it, then verify {\footnotesize{}$\text{ftr}\,f=\text{fmap}\,f\circ\text{tr}$}
with that {\footnotesize{}$\text{tr}$}: {\footnotesize{}$\text{fmap}\,f\circ\text{ftr}\left(\text{id}\right)=\text{ftr}\left(f\circ id\right)=\text{ftr}\,f$}{\footnotesize \par}
\end{itemize}
\end{frame}

\begin{frame}{Semimonad laws IV: Deriving the laws for \texttt{\textcolor{blue}{\footnotesize{}flatten}} }

Denote for brevity $q^{\uparrow}\equiv\text{fmap}^{\left[S\right]}\,q$
for any function $q$

Express $\text{flm}\,f=f^{\uparrow}\circ\text{ftn}$ and substitute
that into $\text{flm}$'s 3 laws:
\begin{enumerate}
\item {\footnotesize{}$\text{flm}\left(f\circ g\right)=f^{\uparrow}\circ\text{flm}\,g$}
gives {\footnotesize{}$\left(f\circ g\right)^{\uparrow}\circ\text{ftn}=f^{\uparrow}\circ g^{\uparrow}\circ\text{ftn}$}\\
\textendash{} this law holds automatically due to functor composition
law
\item {\footnotesize{}$\text{flm}\left(f\circ g^{\uparrow}\right)=\text{flm}\,f\circ g^{\uparrow}$}
gives {\footnotesize{}$\left(f\circ h\right)^{\uparrow}\circ\text{ftn}=f^{\uparrow}\circ\text{ftn}\circ h$};\\
using the functor composition law, we reduce this to\\
{\footnotesize{}$h^{\uparrow}\circ\text{ftn}=\text{ftn}\circ h$}
\textendash{} this is the naturality law
\item {\footnotesize{}$\text{flm}\left(f\circ\text{flm}\,g\right)=\text{flm}\,f\circ\text{flm}\,g$
}with functor composition law gives{\footnotesize{} $f^{\uparrow}\circ g^{\uparrow\uparrow}\circ\text{ftn}^{\uparrow}\circ\text{ftn}=f^{\uparrow}\circ\text{ftn}\circ g^{\uparrow}\circ\text{ftn}$;}
using {\footnotesize{}$\text{ftn}$}'s naturality and omitting the
common factor{\footnotesize{} $f^{\uparrow}\circ g^{\uparrow\uparrow}$},
we get{\footnotesize{} $\text{ftn}^{\uparrow}\circ\text{ftn}=\text{ftn}\circ\text{ftn}$}
\textendash{} associativity law
\end{enumerate}
\begin{itemize}
\item \texttt{\textcolor{blue}{\footnotesize{}flatten}} has the simplest
type signature \emph{and} the fewest laws
\item It is usually easy to check naturality!
\begin{itemize}
\item \textbf{Parametricity theorem}: Any \emph{pure, fully parametric}
code for a function of type $F^{A}\Rightarrow G^{A}$ will implement
a natural transformation
\end{itemize}
\item Checking \texttt{\textcolor{blue}{\footnotesize{}flatten}}'s associativity
needs \emph{a lot} more work!
\end{itemize}
The \texttt{\textcolor{blue}{\footnotesize{}cats}} library has a \texttt{\textcolor{blue}{\footnotesize{}FlatMap}}
type class, defining \texttt{\textcolor{blue}{\footnotesize{}flatten}}
via \texttt{\textcolor{blue}{\footnotesize{}flatMap}} 
\end{frame}

\begin{frame}{Checking the associativity law for standard monads}
\begin{itemize}
\item Implement \texttt{\textcolor{blue}{\footnotesize{}flatten}} for these
functors and check the laws (see code):
\begin{itemize}
\item \texttt{\textcolor{blue}{\footnotesize{}Option}} monad: $F^{A}\equiv1+A$;
$\text{ftn}:1+\left(1+A\right)\Rightarrow1+A$
\item \texttt{\textcolor{blue}{\footnotesize{}Either}} monad: $F^{A}\equiv Z+A$;
$\text{ftn}:Z+\left(Z+A\right)\Rightarrow Z+A$
\item \texttt{\textcolor{blue}{\footnotesize{}List}} monad: $F^{A}\equiv\text{List}^{A}$;
$\text{ftn}:\text{List}^{\text{List}^{A}}\Rightarrow\text{List}^{A}$
\item Writer monad: $F^{A}\equiv A\times W$; $\text{ftn}:\left(A\times W\right)\times W\Rightarrow A\times W$
\item Reader monad: $F^{A}\equiv R\Rightarrow A$; $\text{ftn}:\left(R\Rightarrow\left(R\Rightarrow A\right)\right)\Rightarrow R\Rightarrow A$
\item State: $F^{A}\equiv S\Rightarrow A\times S$; $\text{ftn}:\left(S\Rightarrow\left(S\Rightarrow A\times S\right)\times S\right)\Rightarrow S\Rightarrow A\times S$
\item Continuation monad: $F^{A}\equiv\left(A\Rightarrow R\right)\Rightarrow R$;
$\text{ftn}:\left(\left(\left(\left(A\Rightarrow R\right)\Rightarrow R\right)\Rightarrow R\right)\Rightarrow R\right)\Rightarrow\left(A\Rightarrow R\right)\Rightarrow R$
\end{itemize}
\item Code implementing these \texttt{\textcolor{blue}{\footnotesize{}flatten}}
functions is \emph{fully parametric} in $A$
\begin{itemize}
\item Naturality of these functions follows from parametricity theorem
\item Associativity needs to be checked for each monad!
\end{itemize}
\item Example of a useful semimonad that is \emph{not} a full monad:
\begin{itemize}
\item $F^{A}\equiv A\times V\times W$; $\text{ftn}\left(\left(a\times v_{1}\times w_{1}\right)\times v_{2}\times w_{2}\right)=a\times v_{1}\times w_{2}$
\end{itemize}
\item Examples of \emph{non-associative} (i.e.\                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
\[
\xymatrix{\xyScaleY{0.2pc}\xyScaleX{5pc} & B\ar[rd]\sp(0.5){\ \text{pure}^{\left[S,B\right]}}\\
A\ar[ru]\sp(0.5){f^{A\Rightarrow B}\ }\ar[rd]\sb(0.5){\text{pure}^{[S,A]}\,} &  & S^{B}\\
 & S^{A}\ar[ru]\sb(0.5){\text{fmap}\,f^{A\Rightarrow B}}
}
\]
\item Left identity: $\text{pure}\circ\text{flm}\,f=\text{pure}\circ f^{\uparrow}\circ\text{ftn}=f\circ\text{pure}\circ\text{ftn}=f$
requires that $\text{pure}\circ\text{ftn}=\text{id}$ (both sides
applied to $S^{A}$)
\[
\xymatrix{\xyScaleY{0.2pc}\xyScaleX{3pc} & S^{S^{A}}\ar[rd]\sp(0.5){\ \text{ftn}\ }\\
S^{A}\ar[ru]\sp(0.5){\text{pure}^{[S,S^{A}]}\ }\ar[rr]\sb(0.5){\text{id}} &  & S^{A}
}
\]
\item Right identity: $\text{flm}\left(\text{pure}\right)=\text{pure}^{\uparrow}\circ\text{ftn}=\text{id}$
\[
\xymatrix{\xyScaleY{0.2pc}\xyScaleX{3pc} & S^{S^{A}}\ar[rd]\sp(0.5){\ \text{ftn}\ }\\
S^{A}\ar[ru]\sp(0.5){\text{fmap}(\text{pure}^{[S,A]})\quad}\ar[rr]\sb(0.5){\text{id}} &  & S^{A}
}
\]
\end{itemize}
\end{frame}

\begin{frame}{Formulating laws via Kleisli functions}
\begin{itemize}
\item Recall: we formulated the laws of filterables via \texttt{\textcolor{blue}{\footnotesize{}fmapOpt}} 
\begin{itemize}
\item $\text{fmapOpt}:\left(A\Rightarrow1+B\right)\Rightarrow S^{A}\Rightarrow S^{B}$
\end{itemize}
\item And then we had to compose functions of types $A\Rightarrow1+B$ with
$\diamond_{\text{Opt}}$
\item Here we have $\text{flm}:\left(A\Rightarrow S^{B}\right)\Rightarrow S^{A}\Rightarrow S^{B}$
instead of \texttt{\textcolor{blue}{\footnotesize{}fmapOpt}} 
\item Can we compose \textbf{Kleisli functions} with ``twisted'' types
$A\Rightarrow S^{B}$?
\item Define \textbf{Kleisli composition}: $f^{A\Rightarrow S^{B}}\diamond_{S}g^{B\Rightarrow S^{C}}\equiv f\circ\text{flm}\,g$
\item Define \textbf{Kleisli identity} $\text{id}_{\diamond_{S}}$ of type
$A\Rightarrow S^{A}$ as $\text{pure}:A\Rightarrow S^{A}$
\item Composition law: $\text{flm}\left(f\diamond_{S}g\right)=\text{flm}\,f\circ\text{flm}\,g$
(same as for \texttt{\textcolor{blue}{\footnotesize{}fmapOpt}})
\begin{itemize}
\item Shows that \texttt{\textcolor{blue}{\footnotesize{}flatMap}} is a
``lifting'' of $A\Rightarrow S^{B}$ to $S^{A}\Rightarrow S^{B}$
\end{itemize}
\end{itemize}
Reformulate the monad laws in terms of the $\diamond_{S}$ operation:
\begin{itemize}
\item Left and right identity laws: $\text{id}_{\diamond_{S}}\diamond_{S}f=f$
and $f\diamond_{S}\text{id}_{\diamond_{S}}=f$
\item Associativity law: $\left(f\diamond_{S}g\right)\diamond_{S}h=f\diamond_{S}\left(g\diamond_{S}h\right)$
\item Define \texttt{\textcolor{blue}{\footnotesize{}flatMap}} through Kleisli
composition: $\text{flm}\,f^{A\Rightarrow S^{B}}\equiv\text{id}^{S^{A}\Rightarrow S^{A}}\diamond_{S}f$
\end{itemize}
\end{frame}

\begin{frame}{Structure of semigroups and monoids}

\begin{itemize}
\item Semimonad contexts are combined associatively, as in a semigroup
\item A full monad includes an ``empty'' context, i.e.\ the identity
element
\item Semigroup with an identity element is a monoid
\end{itemize}
Some constructions of semigroups and monoids:
\begin{enumerate}
\item Any type $Z$ is a semigroup with operation $z_{1}\circledast z_{2}=z_{1}$
(or $z_{2}$)
\item $1+S$ is a monoid if $S$ is (at least) a semigroup
\item $\text{List}^{A}$ is a monoid (for any type $A$), also $\text{Seq}^{A}$
etc.
\item The function type $A\Rightarrow A$ is a monoid (for any type $A$)
\begin{itemize}
\item The operation $f\circledast g$ is either $f\circ g$ or $g\circ f$
\end{itemize}
\item Any totally ordered type is a monoid, with $\circledast$ defined
as $\max$ or $\min$
\item $S_{1}\times S_{2}$ is a semigroup (monoid) if $S_{1}$, $S_{2}$
are semigroups (monoids)
\item $S\times P$ is a semigroup (monoid) if $S$ is a semigroup (monoid)
such that $S$ acts on $P$. (``Twisted product.'') Example: $\left(A\Rightarrow A\right)\times A$
\begin{itemize}
\item The ``action'' is $a:S\Rightarrow P\Rightarrow P$ such that $a(s_{1})\circ a(s_{2})=a(s_{1}\circledast s_{2})$.
\end{itemize}
\item $Z\Rightarrow S$ is a semigroup/monoid, for any $Z$, if $S$ is
a semigroup/monoid
\end{enumerate}
\begin{itemize}
\item There are other examples: $\text{Int}$, $\text{String}$, $\text{Set}^{A}$,
Akka routes, ...
\item Non-examples: trees; $S_{1}+S_{2}$ where $S_{1,2}$ are different
monoids
\end{itemize}
\end{frame}

\begin{frame}{Structure of (semi)monads}


\framesubtitle{How to recognize a (semi)monad by its type? Open question!}

Intuition from \texttt{\textcolor{blue}{\footnotesize{}flatten}}:
reshuffle data in $F^{F^{A}}$ to fit into $F^{A}$

Some constructions of exponential-polynomial semimonads ({*} = monad):
\begin{enumerate}
\item $F^{A}\equiv Z$ (constant functor) for a fixed type $Z$
\begin{itemize}
\item For a full monad, need to choose $Z=1$ 
\end{itemize}
\item $F^{A}\equiv A\times G^{A}$ for any functor $G^{A}$ (a full monad
only if $G^{A}\equiv1$)
\item $F^{A}\equiv Z+A\times W$ for a fixed type $Z$ and a semigroup $W$
\begin{itemize}
\item For a full monad, need $W$ to be a monoid
\end{itemize}
\item {*} $F^{A}\equiv G^{Z+A\times W}$ if $Z+A\times W$ is a (semi)monad
\item {*} $F^{A}\equiv G^{A}\times H^{A}$ for any (semi)monads $G^{A}$
and $H^{A}$
\item {*} $F^{A}\equiv A+G^{A}$ for any semimonad $G^{A}$
\item {*} $F^{A}\equiv A+G^{F^{A}}$ (recursive) for any functor $G^{A}$
(\textbf{free monad} over $G$)
\item $F^{A}\equiv G^{A}+G^{F^{A}}$ (recursive) for any functor $G^{A}$
\item $F^{A}\equiv H^{A}\Rightarrow A\times G^{A}$ for any contrafunctor
$H^{A}$ and functor $G^{A}$
\begin{itemize}
\item For a full monad, need to set $G^{A}\equiv1$
\end{itemize}
\end{enumerate}
\end{frame}

\begin{frame}{{*} Worked examples II: Constructions of filterable functors I}

(2) The \texttt{\textcolor{blue}{\footnotesize{}fmapOpt}} laws hold
for $F^{A}\times G^{A}$ if they hold for $F^{A}$ and $G^{A}$
\begin{itemize}
\item For $f^{A\Rightarrow1+B}$, get {\footnotesize{}$\text{fmapOpt}_{F}(f):F^{A}\Rightarrow F^{B}$
}and {\footnotesize{}$\text{fmapOpt}_{G}(f):G^{A}\Rightarrow G^{B}$}{\footnotesize \par}
\item Define {\footnotesize{}$\text{fmapOpt}_{F\times G}f\equiv p^{F^{A}}\times q^{G^{A}}\Rightarrow\text{fmapOpt}_{F}(f)(p)\times\text{fmapOpt}_{G}(f)(q)$}{\footnotesize \par}
\item Identity law: $f=\text{id}_{\diamond_{\text{Opt}}}$, so {\footnotesize{}$\text{fmapOpt}_{F}f=\text{id}$}
and {\footnotesize{}$\text{fmapOpt}_{G}f=\text{id}$}{\footnotesize \par}
\begin{itemize}
\item Hence we get $\text{fmapOpt}_{F+G}(f)(p\times q)=\text{id}(p)\times\text{id}(q)=p\times q$
\end{itemize}
\item Composition law:{\footnotesize{}
\begin{align*}
 & (\text{fmapOpt}_{F\times G}\,f_{1}\circ\text{fmapOpt}_{F+G}\,f_{2})(p\times q)\\
=\  & \text{fmapOpt}_{F\times G}(f_{2})\left(\text{fmapOpt}_{F}(f_{1})(p)\times\text{fmapOpt}_{G}(f_{1})(q)\right)\\
=\  & (\text{fmapOpt}_{F}\,f_{1}\circ\text{fmapOpt}_{F}\,f_{2})(p)\times\left(\text{fmapOpt}_{G}\,f_{1}\circ\text{fmapOpt}_{G}\,f_{2}\right)(q)\\
=\  & \text{fmapOpt}_{F}(f_{1}\diamond_{\text{Opt}}f_{2})(p)\times\text{fmapOpt}_{G}(f_{1}\diamond f_{2})(q)\\
=\  & \text{fmapOpt}_{F\times G}(f_{1}\diamond_{\text{Opt}}f_{2})(p\times q)
\end{align*}
}{\footnotesize \par}
\item Exactly the same proof as that for functor property for $F^{A}\times G^{A}$
\begin{itemize}
\item this is because \texttt{\textcolor{blue}{\footnotesize{}fmapOpt}}
corresponds to a generalized functor
\end{itemize}
\item New proofs are necessary only when using non-filterable functors
\begin{itemize}
\item these are used in constructions 4 \textendash{} 6
\end{itemize}
\end{itemize}
\end{frame}

\begin{frame}{{*} Worked examples II: Constructions of filterable functors II}

(5) The \texttt{\textcolor{blue}{\footnotesize{}fmapOpt}} laws hold
for $F^{A}\equiv1+A\times G^{A}$ if they hold for $G^{A}$
\begin{itemize}
\item For $f^{A\Rightarrow1+B}$, get {\footnotesize{}$\text{fmapOpt}_{G}(f):G^{A}\Rightarrow G^{B}$}{\footnotesize \par}
\item {\footnotesize{}Define $\text{fmapOpt}_{F}(f)(1+a^{A}\times q^{G^{A}})$
by returning $0+b\times\text{fmapOpt}_{G}(f)(q)$ if the argument
is $0+a\times q$ and $f(a)=0+b$, and returning $1+0$ otherwise}{\footnotesize \par}
\item Identity law: {\footnotesize{}$f=\text{id}_{\diamond_{\text{Opt}}}$,
so $f(a)=0+a$ and $\text{fmapOpt}_{G}f=\text{id}$}{\footnotesize \par}
\begin{itemize}
\item Hence we get{\footnotesize{} $\text{fmapOpt}_{F}(\text{id}_{\diamond_{\text{Opt}}})(1+a\times q)=1+a\times q$}{\footnotesize \par}
\end{itemize}
\item Composition law: {\footnotesize{}need only to check for arguments
$0+a\times q$, and only when $f_{1}(a)=0+b$ and $f_{2}(b)=0+c$,
in which case $(f_{1}\diamond_{\text{Opt}}f_{2})(a)=0+c$; then 
\begin{align*}
 & (\text{fmapOpt}_{F}\,f_{1}\circ\text{fmapOpt}_{F}\,f_{2})(0+a\times q)\\
=\  & \text{fmapOpt}_{F}(f_{2})\left(\text{fmapOpt}_{F}(f_{1})(0+a\times q)\right)\\
=\  & \text{fmapOpt}_{F}(f_{2})\left(0+b\times\text{fmapOpt}_{G}(f_{1})(q)\right)\\
=\  & 0+c\times(\text{fmapOpt}_{G}\,f_{1}\circ\text{fmapOpt}_{G}\,f_{2})(q)\\
=\  & 0+c\times\text{fmapOpt}_{G}(f_{1}\diamond_{\text{Opt}}f_{2})(q)\\
=\  & \text{fmapOpt}_{F}(f_{1}\diamond_{\text{Opt}}f_{2})(0+a\times q)
\end{align*}
}{\footnotesize \par}
\end{itemize}
This is a ``greedy filter'': if $f(a)$ is empty, will delete all
data in $G^{A}$
\end{frame}

\begin{frame}{{*} Worked examples II: Constructions of filterable functors III}

(6) The \texttt{\textcolor{blue}{\footnotesize{}fmapOpt}} laws hold
for $F^{A}\equiv G^{A}+A\times F^{A}$ if they hold for $G^{A}$
\begin{itemize}
\item {\footnotesize{}For $f^{A\Rightarrow1+B}$, we have $\text{fmapOpt}_{G}(f):G^{A}\Rightarrow G^{B}$
and $\text{fmapOpt}_{F}^{\prime}(f):F^{A}\Rightarrow F^{B}$ (for
use in recursive arguments as the inductive assumption)}{\footnotesize \par}
\item {\footnotesize{}Define $\text{fmapOpt}_{F}(f)(q^{G^{A}}+a^{A}\times p^{F^{A}})$
by returning $0+\text{fmapOpt}_{F}^{\prime}(f)(p)$ if $f(a)=1+0$,
and $\text{fmapOpt}_{G}(f)(q)+b\times\text{fmapOpt}_{F}^{\prime}(f)(p)$
otherwise}{\footnotesize \par}
\item Identity law: {\footnotesize{}$\text{id}_{\diamond_{\text{Opt}}}(x)\neq1+0$},
so {\footnotesize{}$\text{fmapOpt}_{F}(\text{id}_{\diamond_{\text{Opt}}})(q+a\times p)=q+a\times p$ }{\footnotesize \par}
\item Composition law: {\footnotesize{}$(\text{fmapOpt}_{F}(f_{1})\circ\text{fmapOpt}_{F}(f_{2}))(q+a\times p)=\text{fmapOpt}_{F}(f_{1}\diamond_{\text{Opt}}f_{2})(q+a\times p)$}{\footnotesize \par}
\item {\footnotesize{}For arguments $q+0$, the laws for $G^{A}$ hold;
so assume arguments $0+a\times p$. When $f_{1}(a)=0+b$ and $f_{2}(b)=0+c$,
the proof of the previous example will go through. So we need to consider
the two cases $f_{1}(a)=1+0$ and $f_{1}(a)=0+b$, $f_{2}(b)=1+0$ }{\footnotesize \par}
\item {\footnotesize{}If $f_{1}(a)=1+0$ then $(f_{1}\diamond_{\text{Opt}}f_{2})(a)=1+0$;
to show $\text{fmapOpt}_{F}^{\prime}(f_{2})(\text{fmapOpt}_{F}^{\prime}(f_{1})(p))$
$=\text{fmapOpt}_{F}^{\prime}(f_{1}\diamond_{\text{Opt}}f_{2})(p)$,
use the inductive assumption about $\text{fmapOpt}_{F}^{\prime}$
on $p$}{\footnotesize \par}
\item {\footnotesize{}If $f_{1}(a)=0+b$ and $f_{2}(b)=1+0$ then $(f_{1}\diamond_{\text{Opt}}f_{2})(a)=1+0$;
to show $\text{fmapOpt}_{F}(f_{2})(0+b\times\text{fmapOpt}_{F}^{\prime}(f_{1})(p))$
$=\text{fmapOpt}_{F}^{\prime}(f_{1}\diamond_{\text{Opt}}f_{2})(p)$,
rewrite $\text{fmapOpt}_{F}(f_{2})(0+b\times\text{fmapOpt}_{F}^{\prime}(f_{1})(p))$
$=\text{fmapOpt}_{F}^{\prime}(f_{2})(\text{fmapOpt}_{F}^{\prime}(f_{1})(p))$
and again use the inductive assumption about $\text{fmapOpt}_{F}^{\prime}$
on $p$}{\footnotesize \par}
\end{itemize}
This is a ``list-like filter'': if $f(a)$ is empty, will recurse
into nested $F^{A}$ data
\end{frame}

\begin{frame}{Worked examples II: Constructions of filterable functors IV}

Use known filterable constructions to show that{\footnotesize{} $F^{A}\equiv(\text{Int}\times\text{String})\Rightarrow\left(1+\text{Int}\times A+A\times\left(1+A\right)+\left(\text{Int}\Rightarrow1+A+A\times A\times\text{String}\right)\right)$
}is a filterable functor
\begin{itemize}
\item Instead of implementing \texttt{\textcolor{blue}{\footnotesize{}Filterable}}
and verifying laws by hand, we analyze the structure of this data
type and use known constructions
\item Define some auxiliary functors that are parts of the structure of
$F^{A}$,
\begin{itemize}
\item $R_{1}^{A}=\left(\text{Int}\times\text{String}\right)\Rightarrow A$
and $R_{2}^{A}=\text{Int}\Rightarrow A$ 
\item $G^{A}=1+\text{Int}\times A+A\times\left(1+A\right)$ and $H^{A}=1+A+A\times A\times\text{String}$
\end{itemize}
\item Now we can rewrite {\footnotesize{}$F^{A}=R_{1}\left[G^{A}+R_{2}\left[H^{A}\right]\right]$}{\footnotesize \par}
\begin{itemize}
\item $G^{A}$ is filterable by construction 5 because it is of the form
$G^{A}=1+A\times K^{A}$ with filterable functor $K^{A}=1+\text{Int}+A$
\item $K^{A}$ is of the form $1+A+X$ with constant type $X$, so it is
filterable by constructions 1 and 3 with the \texttt{\textcolor{blue}{\footnotesize{}Option}}
functor $1+A$
\item $H^{A}$ is filterable by construction 5 with $H^{A}=1+A\times\left(1+A\times\text{String}\right)$,
while $1+A\times\text{String}$ is filterable by constructions 5 and
1
\end{itemize}
\item Constructions 3 and 4 show that $R_{1}\left[G^{A}+R_{2}\left[H^{A}\right]\right]$
is filterable
\end{itemize}
Note that there are more than one way of implementing \texttt{\textcolor{blue}{\footnotesize{}Filterable}}
here
\end{frame}

\begin{frame}{{*} Exercises II}
\begin{enumerate}
\item Implement a \texttt{\textcolor{blue}{\footnotesize{}Filterable}} instance
for \texttt{\textcolor{blue}{\footnotesize{}type F{[}T{]} = G{[}H{[}T{]}{]}}}
assuming that the functor \texttt{\textcolor{blue}{\footnotesize{}H{[}T{]}}}
already has a \texttt{\textcolor{blue}{\footnotesize{}Filterable}}
instance (construction 4). Verify the laws rigorously (i.e.\ by calculations,
not tests).
\item For \texttt{\textcolor{blue}{\footnotesize{}type F{[}T{]} = Option{[}Int
$\Rightarrow$ Option{[}(T, T){]}{]}}}, implement a \texttt{\textcolor{blue}{\footnotesize{}Filterable}}
instance. Show that the filterable laws hold by using known filterable
constructions (avoiding explicit proofs or tests).
\item Implement a \texttt{\textcolor{blue}{\footnotesize{}Filterable}} instance
for $F^{A}\equiv G^{A}+\text{Int}\times A\times A\times F^{A}$ (recursive)
for a filterable functor $G^{A}$. Verify the laws rigorously.
\item Show that $F^{A}=1+A\times G^{A}$ is in general \emph{not} filterable
if $G^{A}$ is an arbitrary (non-filterable) functor; it is enough
to give an example.
\item Show that $F^{A}=1+G^{A}+H^{A}$ is filterable if $1+G^{A}$ and $1+H^{A}$
are filterable (even when $G^{A}$ and $H^{A}$ are by themselves
not filterable).
\item Show that the functor $F^{A}=A+\left(\text{Int}\Rightarrow A\right)$
is not filterable.
\item Show that one can define \texttt{\textcolor{blue}{\footnotesize{}deflate}}$:C^{1+A}\Rightarrow C^{A}$
for any contrafunctor $C^{A}$ (not necessarily filterable), similarly
to how one can define \texttt{\textcolor{blue}{\footnotesize{}inflate}}$:F^{A}\Rightarrow F^{1+A}$
for any functor $F^{A}$ (not necessarily filterable). 
\end{enumerate}
\end{frame}

\end{document}
